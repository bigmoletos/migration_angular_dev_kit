<#
.SYNOPSIS
    Cr√©e un snapshot d'un fichier avant modification

.DESCRIPTION
    Ce script cr√©e une copie de sauvegarde (snapshot) d'un fichier dans le dossier 
    .kiro-backup/snapshots/ avant toute modification, permettant un rollback facile.
    
    Le syst√®me de snapshots remplace l'ancienne m√©thode des commentaires dans les fichiers,
    gardant ainsi les fichiers propres et lisibles (notamment les fichiers JSON).

.VERSION
    1.0.0

.LAST UPDATE
    2026-02-04

.AUTHOR
    Kiro

.CHANGELOG
    v1.0.0 (2026-02-04) : Cr√©ation initiale

.PARAMETER File
    Chemin du fichier √† sauvegarder (relatif ou absolu)

.PARAMETER Description
    Description de la modification pr√©vue (optionnel)

.PARAMETER Palier
    Num√©ro du palier de migration (optionnel, d√©faut: 0)

.EXAMPLE
    .\snapshot-file.ps1 -File "pwc-ui/pwc-ui-v4-ia/package.json"

.EXAMPLE
    .\snapshot-file.ps1 -File "pwc-ui/pwc-ui-v4-ia/package.json" -Description "Ajout de json-ignore" -Palier 1
#>

param(
    [Parameter(Mandatory=$true)]
    [string]$File,
    
    [Parameter(Mandatory=$false)]
    [string]$Description = "",
    
    [Parameter(Mandatory=$false)]
    [int]$Palier = 0
)

# Configuration
$backupRoot = ".kiro-backup"
$snapshotsDir = "$backupRoot/snapshots"
$diffsDir = "$backupRoot/diffs"
$indexFile = ".kiro/state/modifications-index.json"

# V√©rifier que le fichier existe
if (-not (Test-Path $File)) {
    Write-Error "‚ùå Fichier non trouv√© : $File"
    exit 1
}

# G√©n√©rer un ID unique
$modId = "mod-$(Get-Date -Format 'yyyyMMdd-HHmmss')"
$date = Get-Date -Format "yyyy-MM-dd"
$timestamp = Get-Date -Format "yyyy-MM-ddTHH:mm:ssZ"

# Cr√©er les dossiers si n√©cessaire
$snapshotDateDir = "$snapshotsDir/$date"
if (-not (Test-Path $snapshotDateDir)) {
    New-Item -ItemType Directory -Path $snapshotDateDir -Force | Out-Null
    Write-Host "üìÅ Dossier cr√©√© : $snapshotDateDir"
}

if (-not (Test-Path $diffsDir)) {
    New-Item -ItemType Directory -Path $diffsDir -Force | Out-Null
    Write-Host "üìÅ Dossier cr√©√© : $diffsDir"
}

# Extraire le nom du fichier
$fileName = Split-Path $File -Leaf
$snapshotFile = "$snapshotDateDir/$modId-$fileName"

# Cr√©er le snapshot
Copy-Item $File $snapshotFile -Force
Write-Host "‚úÖ Snapshot cr√©√© : $snapshotFile"

# Pr√©parer l'entr√©e pour l'index
$modification = @{
    id = $modId
    date = $timestamp
    author = "Kiro"
    file = $File
    type = "modification"
    description = $Description
    reason = ""
    snapshot = $snapshotFile
    diff = "$diffsDir/$modId.diff"
    palier = $Palier
    relatedJournalEntry = $date
    status = "pending"
    rollbackTested = $false
}

# Lire l'index existant ou cr√©er un nouveau
if (Test-Path $indexFile) {
    $index = Get-Content $indexFile -Raw | ConvertFrom-Json
} else {
    $index = @{
        metadata = @{
            version = "2.0.0"
            lastUpdate = $date
            system = "snapshots"
        }
        config = @{
            snapshotsDir = $snapshotsDir
            diffsDir = $diffsDir
            retentionDays = 30
            autoGenerateDiff = $true
        }
        modifications = @()
    }
}

# Ajouter la modification √† l'index
$index.modifications += $modification
$index.metadata.lastUpdate = $date

# Sauvegarder l'index
$index | ConvertTo-Json -Depth 10 | Set-Content $indexFile -Encoding UTF8
Write-Host "‚úÖ Index mis √† jour : $indexFile"

# Afficher le r√©sum√©
Write-Host ""
Write-Host "üì∏ SNAPSHOT CR√â√â"
Write-Host "================"
Write-Host "ID          : $modId"
Write-Host "Fichier     : $File"
Write-Host "Snapshot    : $snapshotFile"
Write-Host "Description : $Description"
Write-Host "Palier      : $Palier"
Write-Host ""
Write-Host "‚ö†Ô∏è  N'oubliez pas de g√©n√©rer le diff apr√®s modification :"
Write-Host "    .\scripts_outils_ia\generate-diff.ps1 -ModificationId $modId"
Write-Host ""

# Retourner l'ID pour utilisation ult√©rieure
return $modId
